# -*- coding: utf-8 -*-
"""
Created on Mon Mar 20 10:27:19 2023

@author: jacob
"""
import os, glob, sys
import dask
import xarray as xr
import rioxarray as rxr
from rioxarray.merge import merge_arrays
sys.path.append(r"D:\PhD\YieldProject\Scripts\02_Preprocess")
import yieldfunctions as yf

# Set paths to GDAL in virtual env to avoid proj.db errors
os.environ['PROJ_LIB'] = r"C:\Users\jacob\.conda\envs\yieldproj\Library\share\proj"
os.environ['GDAL_DATA'] = r"C:\Users\jacob\.conda\envs\yieldproj\Library\share"

# Config dask
dask.config.set(**{'array.slicing.split_large_chunks': True})

ndviDir = r"D:\PhD\YieldProject\Data\NDVI_Anomalies"
cdmDir = r"D:\PhD\AAFC_Data\CDM\Final"
outDir = r"D:\PhD\YieldProject\Data\CDM"

# Get ndvi template
ndviPath = ndviDir + "\\NDVIAnomalies_20102021_Baseline20022021.nc"
ndvi = xr.open_dataset(ndviPath, chunks = {'time':1,'x':500,'y':500})
ndvi = ndvi.set_coords(("spatial_ref"))
ndvi_template = ndvi.isel(time=0).compute().chunk('auto')
proj = ndvi_template.spatial_ref.crs_wkt

outfile = outDir + "//cdm_20102021.nc"
cdmstack = yf.create_cdmstack_jw(cdmDir, ndvi_template, proj, outfile)
